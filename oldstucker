-- PetStick.lua  (unified server+client)

local RunService         = game:GetService("RunService")
local ReplicatedStorage  = game:GetService("ReplicatedStorage")
local Players            = game:GetService("Players")
local Workspace          = game:GetService("Workspace")

-- CONFIG: change this to wherever your plants live
local PLANT_FOLDER = Workspace:WaitForChild("Plants")

-- ensure RemoteEvent
local stickEvent = ReplicatedStorage:FindFirstChild("StickPetEvent")
if not stickEvent then
    stickEvent = Instance.new("RemoteEvent")
    stickEvent.Name   = "StickPetEvent"
    stickEvent.Parent = ReplicatedStorage
end

if RunService:IsServer() then
    ------------- SERVER -------------
    -- inline PetLocker using AlignPosition
    local PetLocker = {}
    PetLocker._locked = {}

    function PetLocker:LockPet(petModel, targetCFrame)
        assert(petModel.PrimaryPart, "Pet must have PrimaryPart set")
        -- clean old
        if self._locked[petModel] then
            self:UnlockPet(petModel)
        end

        local root = petModel.PrimaryPart
        -- world attachment
        local worldAt = Instance.new("Attachment", Workspace)
        worldAt.WorldPosition    = targetCFrame.Position
        worldAt.WorldOrientation = targetCFrame - targetCFrame.Position
        -- pet attachment
        local petAt = Instance.new("Attachment", root)

        -- align position
        local ap = Instance.new("AlignPosition", root)
        ap.Attachment0    = petAt
        ap.Attachment1    = worldAt
        ap.RigidityEnabled  = true
        ap.MaxForce         = Vector3.new(1e5,1e5,1e5)
        ap.Responsiveness   = 200

        -- align orientation
        local ao = Instance.new("AlignOrientation", root)
        ao.Attachment0    = petAt
        ao.Attachment1    = worldAt
        ao.RigidityEnabled = true
        ao.MaxTorque       = Vector3.new(1e4,1e4,1e4)
        ao.Responsiveness  = 200

        self._locked[petModel] = {worldAt, petAt, ap, ao}
    end

    function PetLocker:UnlockPet(petModel)
        local data = self._locked[petModel]
        if not data then return end
        for _, obj in ipairs(data) do
            if obj and obj.Parent then obj:Destroy() end
        end
        self._locked[petModel] = nil
    end

    -- handle requests
    stickEvent.OnServerEvent:Connect(function(player, plant)
        if typeof(plant)~="Instance" or not plant:IsDescendantOf(Workspace) then return end
        -- adjust this to find your player's pet model
        local petModel = Workspace:FindFirstChild("Pets") and Workspace.Pets:FindFirstChild(player.Name)
        if not petModel then return end

        -- find a part to attach to
        local anchorPart = plant.PrimaryPart or plant:FindFirstChildWhichIsA("BasePart")
        if not anchorPart then return end

        -- compute offset: sit on top of the plant
        local offsetY = anchorPart.Size.Y/2 + (petModel:GetExtentsSize().Y/2)
        local cf = anchorPart.CFrame * CFrame.new(0, offsetY, 0)
        PetLocker:LockPet(petModel, cf)
    end)

else
    ------------- CLIENT -------------
    local player = Players.LocalPlayer
    local mouse  = player:GetMouse()

    -- build UI
    local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
    gui.Name = "PetStickGui"
    gui.ResetOnSpawn = false

    local frame = Instance.new("Frame", gui)
    frame.Size     = UDim2.new(0, 200, 0, 300)
    frame.Position = UDim2.new(0, 20, 0.5, -150)
    frame.BackgroundColor3 = Color3.fromRGB(30,30,30)
    frame.BorderSizePixel  = 0

    local uiList = Instance.new("UIListLayout", frame)
    uiList.SortOrder = Enum.SortOrder.LayoutOrder
    uiList.Padding   = UDim.new(0,4)

    -- header
    local header = Instance.new("TextLabel", frame)
    header.Text       = "Stick Pet to Plant"
    header.Size       = UDim2.new(1,0,0,30)
    header.BackgroundColor3 = Color3.fromRGB(50,50,50)
    header.TextColor3 = Color3.new(1,1,1)
    header.Font       = Enum.Font.GothamBold
    header.TextSize   = 18

    -- Populate one button per plant
    for _, plant in ipairs(PLANT_FOLDER:GetChildren()) do
        if plant:IsA("Model") then
            local btn = Instance.new("TextButton", frame)
            btn.Size       = UDim2.new(1, -10, 0, 25)
            btn.Position   = UDim2.new(0, 5, 0, 0)
            btn.Text       = plant.Name
            btn.Font       = Enum.Font.Gotham
            btn.TextSize   = 16
            btn.TextColor3 = Color3.new(1,1,1)
            btn.BackgroundColor3 = Color3.fromRGB(70,70,70)

            btn.MouseButton1Click:Connect(function()
                stickEvent:FireServer(plant)
            end)
        end
    end
end
